# MetrosDPI
<img width="640" height="480" alt="image" src="https://github.com/user-attachments/assets/5fe4f87c-08fb-454d-b132-11719ef117ee" />

Графический интерфейс для управления winws — инструментом фильтрации и перенаправления сетевого трафика.

## Описание

MetrosDPI — это современное приложение с темным интерфейсом в стиле Visual Studio Code, предназначенное для удобного управления стратегиями фильтрации трафика через winws. Программа предоставляет интуитивно понятный интерфейс для запуска, остановки и создания стратегий фильтрации, а также управления различными фильтрами и настройками.

## Основные возможности

### Управление стратегиями
- **Запуск и остановка стратегий** — простой интерфейс для управления стратегиями фильтрации трафика
- **Автозапуск последней стратегии** — автоматический запуск последней использованной стратегии при старте программы
- **Автоматический перезапуск** — автоматический перезапуск стратегии при сбое процесса winws.exe
- **Создание стратегий** — встроенный редактор для создания собственных стратегий фильтрации с настройкой:
  - TCP/UDP портов
  - L7 и L3 протоколов
  - Списков доменов (Hostlist)
  - IPSet списков
  - Game Filter

### Фильтры
- **Game Filter** — фильтр для исключения игрового трафика из обработки
- **IPSet Filter** — управление режимами фильтрации по IP-адресам:
  - `loaded` — использование загруженного списка IP-адресов
  - `none` — блокировка всех IP-адресов (кроме служебного)
  - `any` — разрешение всех IP-адресов

### Обновления
- **Автоматическая проверка обновлений** — проверка новых версий zapret на GitHub
- **Ручное обновление** — возможность вручную обновить списки zapret
- **Флаг `-b` при обновлении** — опциональное добавление флага `-b` при обновлении списков

### Тестирование и диагностика
- **Окно тестирования** — тестирование стратегий с проверкой:
  - HTTP-соединений
  - TLS-соединений
  - Ping-проверок
- **Диагностика** — запуск диагностических тестов для проверки работоспособности системы

### Настройки
- **Многоязычность** — поддержка русского и английского языков
- **Системный трей** — работа в фоновом режиме с иконкой в системном трее
- **Автозапуск** — настройка автозапуска программы при входе в систему через Task Scheduler
- **Поведение при выходе** — настройка закрытия winws при выходе из программы
- **Запуск свернутым** — возможность запуска программы в свернутом виде

### Интерфейс
- **Темная тема** — современный темный интерфейс в стиле Visual Studio Code
- **Frameless окна** — окна без стандартных рамок Windows с кастомным заголовком
- **Плавные анимации** — анимации при изменении состояния окна (максимизация, минимизация)
- **Overlay скроллбары** — скроллбары в стиле VS Code, накладывающиеся поверх контента
- **Кастомные элементы управления** — стилизованные комбобоксы и другие элементы интерфейса

## Требования

- **ОС**: Windows 10/11
- **Права администратора**: Обязательны для работы программы
- **Python**: 3.8+ (для запуска из исходников)
- **Зависимости**:
  - PyQt6
  - psutil
  - requests

## Установка

### Из исходников

1. Клонируйте репозиторий или распакуйте архив
2. Установите зависимости:
   ```bash
   pip install PyQt6 psutil requests
   ```
3. Запустите программу:
   ```bash
   python main.py
   ```

### Из исполняемого файла

1. Скачайте последнюю версию исполняемого файла
2. Запустите `metrosdpi.exe` от имени администратора

## Использование

### Запуск стратегии

1. Выберите стратегию из выпадающего списка
2. Нажмите кнопку **"Запустить"**
3. Для остановки нажмите кнопку **"Остановить"**

### Создание стратегии

1. Откройте меню **Tools → Create Strategy**
2. Заполните параметры стратегии:
   - Название стратегии
   - TCP/UDP порты (через запятую или диапазон через дефис)
   - L7 протоколы (например: `discord,stun`)
   - L3 протоколы (например: `ipv4`)
   - Списки доменов (Hostlist)
   - IPSet списки
   - Опции Game Filter
3. Нажмите **"Создать"**

### Настройки

Откройте меню **Settings** для доступа к настройкам:
- **Язык** — выбор языка интерфейса
- **Трей** — настройки работы в системном трее
- **Поведение при выходе** — настройка закрытия winws при выходе
- **Автозапуск** — настройка автозапуска программы
- **Обновление** — настройки проверки и установки обновлений

### Системный трей

При работе в фоновом режиме программа отображается в системном трее. Щелчок правой кнопкой мыши по иконке открывает контекстное меню с возможностями:
- Показать/скрыть окно
- Изменить стратегию
- Запустить/остановить текущую стратегию
- Открыть настройки
- Выход

## Структура проекта

```
metrosdpi-main/
├── main.py                      # Точка входа приложения
├── main_window.py              # Главное окно приложения
├── config_manager.py           # Управление конфигурацией
├── winws_manager.py            # Управление настройками winws
├── strategy_creator_window.py  # Окно создания стратегий
├── settings_dialog.py          # Диалог настроек
├── system_tray.py              # Системный трей
├── test_window.py              # Окно тестирования
├── zapret_updater.py           # Обновление zapret
├── autostart_manager.py        # Управление автозапуском
├── frameless_window.py         # Базовый класс frameless окна
├── frameless_dialog.py         # Базовый класс frameless диалога
├── title_bar.py                # Кастомный заголовок окна
├── window_frame.py             # Обработка изменения размера окна
├── custom_combobox.py          # Кастомный комбобокс
├── custom_scrollbar.py         # Управление overlay скроллбарами
├── custom_overlay_scrollbar.py # Кастомный overlay скроллбар
├── translator.py               # Система переводов
├── path_utils.py               # Утилиты для работы с путями
├── bat_generator.py            # Генератор bat-файлов стратегий
├── json/
│   └── config.json             # Файл конфигурации
├── resources/
│   ├── assets/                 # Ресурсы (иконки, изображения)
│   └── styles/
│       └── app.qss             # Стили приложения
└── winws/
    ├── bin/                    # Исполняемые файлы winws
    ├── lists/                  # Списки доменов и IP-адресов
    ├── utils/                  # Утилиты и флаги
    └── *.bat                   # Файлы стратегий
```

## Конфигурация

Настройки программы хранятся в файле `json/config.json`:

```json
{
    "app": {
        "language": "ru",
        "show_in_tray": true,
        "close_winws_on_exit": true,
        "start_minimized": false,
        "auto_start_last_strategy": false,
        "add_b_flag_on_update": false,
        "last_strategy": "",
        "auto_restart_strategy": false,
        "game_filter_enabled": false,
        "ipset_filter_mode": "loaded"
    },
    "app_version": {
        "version": "1.4.0",
        "md5": "..."
    },
    "zapret_version": {
        "version": "1.9.3"
    }
}
```

## Решение проблем

### Программа требует права администратора

MetrosDPI обязательно должна запускаться от имени администратора для работы с сетевым трафиком. При запуске программа автоматически запросит повышение прав.

### Стратегия не запускается

1. Убедитесь, что файл стратегии существует в папке `winws/`
2. Проверьте, что winws.exe находится в папке `winws/bin/`
3. Запустите диагностику через меню **Tools → Run Diagnostics**

### Процесс winws.exe не запускается

1. Проверьте логи в окне тестирования
2. Убедитесь, что все необходимые файлы присутствуют в папке `winws/bin/`
3. Проверьте, не блокирует ли антивирус работу программы

## Версия

Текущая версия: **1.4.0**

## Авторы

Metros Software

## Благодарности

- [winws](https://github.com/...) — инструмент фильтрации трафика
- [zapret](https://github.com/Flowseal/zapret-discord-youtube) — списки блокировки

---

**Примечание**: Редактор списков будет добавлен в следующей версии программы.

